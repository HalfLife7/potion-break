{"version":3,"sources":["../src/index.js"],"names":["https","process","env","NODE_ENV","require","config","express","session","MemoryStore","bodyParser","path","mustacheExpress","passport","SteamStrategy","Strategy","User","serializeUser","user","done","deserializeUser","obj","returnURL","BASE_URL","PORT","realm","console","log","use","apiKey","STEAM_API_KEY","identifier","profile","nextTick","userInfo","personaname","_json","profileurl","steamid","avatarfull","getUser","query","findOne","then","err","error","message","insertUser","insert","steam_persona_name","steam_profile","steam_id","steam_avatar","updateUser","patch","undefined","results","app","urlencoded","extended","json","viewsPath","join","__dirname","viewsPages","engine","set","secret","SESSION_SECRET","name","resave","saveUninitialized","secure","cookie","maxAge","store","checkPeriod","initialize","verify","req","res","buf","originalUrl","startsWith","rawBody","toString","routes","port","server","listen"],"mappings":";;AAAA;AACA;AACAA,KAAK,EAAE,IAAIC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAA7B,EAA2C;AAChDC,EAAAA,OAAO,CAAC,QAAD,CAAP,CAAkBC,MAAlB;AACD;;AACD,IAAMC,OAAO,GAAGF,OAAO,CAAC,SAAD,CAAvB;;AACA,IAAMG,OAAO,GAAGH,OAAO,CAAC,iBAAD,CAAvB;;AACA,IAAII,WAAW,GAAGJ,OAAO,CAAC,aAAD,CAAP,CAAuBG,OAAvB,CAAlB;;AACA,IAAME,UAAU,GAAGL,OAAO,CAAC,aAAD,CAA1B;;AACA,IAAMM,IAAI,GAAGN,OAAO,CAAC,MAAD,CAApB;;AACA,IAAMO,eAAe,GAAGP,OAAO,CAAC,kBAAD,CAA/B;;AACA,IAAMQ,QAAQ,GAAGR,OAAO,CAAC,UAAD,CAAxB;;AACA,IAAMS,aAAa,GAAGT,OAAO,CAAC,gCAAD,CAAP,CAA0CU,QAAhE;;AAEA,IAAMC,IAAI,GAAGX,OAAO,CAAC,gBAAD,CAApB,C,CAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACAQ,QAAQ,CAACI,aAAT,CAAuB,UAAUC,IAAV,EAAgBC,IAAhB,EAAsB;AAC3CA,EAAAA,IAAI,CAAC,IAAD,EAAOD,IAAP,CAAJ;AACD,CAFD;AAIAL,QAAQ,CAACO,eAAT,CAAyB,UAAUC,GAAV,EAAeF,IAAf,EAAqB;AAC5CA,EAAAA,IAAI,CAAC,IAAD,EAAOE,GAAP,CAAJ;AACD,CAFD,E,CAIA;AACA;AACA;AACA;;AAEA,IAAMC,SAAS,GACbpB,OAAO,CAACC,GAAR,CAAYoB,QAAZ,GAAuB,GAAvB,GAA6BrB,OAAO,CAACC,GAAR,CAAYqB,IAAzC,GAAgD,oBADlD;AAEA,IAAMC,KAAK,GAAGvB,OAAO,CAACC,GAAR,CAAYoB,QAAZ,GAAuB,GAAvB,GAA6BrB,OAAO,CAACC,GAAR,CAAYqB,IAAvD;AAEAE,OAAO,CAACC,GAAR,CAAYL,SAAZ;AACAI,OAAO,CAACC,GAAR,CAAYF,KAAZ;AAEAZ,QAAQ,CAACe,GAAT,CACE,IAAId,aAAJ,CACE;AACEQ,EAAAA,SAAS,EAAEA,SADb;AAEEG,EAAAA,KAAK,EAAEA,KAFT;AAGEI,EAAAA,MAAM,EAAE3B,OAAO,CAACC,GAAR,CAAY2B;AAHtB,CADF,EAME,UAAUC,UAAV,EAAsBC,OAAtB,EAA+Bb,IAA/B,EAAqC;AACnC;AACAjB,EAAAA,OAAO,CAAC+B,QAAR,CAAiB,YAAY;AAC3B;AACA,QAAMC,QAAQ,GAAG;AACfC,MAAAA,WAAW,EAAEH,OAAO,CAACI,KAAR,CAAcD,WADZ;AAEfE,MAAAA,UAAU,EAAEL,OAAO,CAACI,KAAR,CAAcC,UAFX;AAGfC,MAAAA,OAAO,EAAEN,OAAO,CAACI,KAAR,CAAcE,OAHR;AAIfC,MAAAA,UAAU,EAAEP,OAAO,CAACI,KAAR,CAAcG;AAJX,KAAjB,CAF2B,CAS3B;AACA;AACA;AACA;AACA;;AACA,aAASC,OAAT,GAAmB;AACjB,aAAOxB,IAAI,CAACyB,KAAL,GACJC,OADI,CACI,UADJ,EACgB,GADhB,EACqBR,QAAQ,CAACI,OAD9B,EAEJK,IAFI,CAEC,UAACzB,IAAD,EAAU;AACd,eAAOA,IAAP;AACD,OAJI,WAKE,UAAC0B,GAAD,EAAS;AACdlB,QAAAA,OAAO,CAACmB,KAAR,CAAcD,GAAG,CAACE,OAAlB;AACD,OAPI,CAAP;AAQD;;AAED,aAASC,UAAT,GAAsB;AACpB,aAAO/B,IAAI,CAACyB,KAAL,GACJO,MADI,CACG;AACNC,QAAAA,kBAAkB,EAAEf,QAAQ,CAACC,WADvB;AAENe,QAAAA,aAAa,EAAEhB,QAAQ,CAACG,UAFlB;AAGNc,QAAAA,QAAQ,EAAEjB,QAAQ,CAACI,OAHb;AAINc,QAAAA,YAAY,EAAElB,QAAQ,CAACK;AAJjB,OADH,EAOJI,IAPI,CAOC,UAACzB,IAAD,EAAU;AACd,eAAOA,IAAP;AACD,OATI,WAUE,UAAC0B,GAAD,EAAS;AACdlB,QAAAA,OAAO,CAACmB,KAAR,CAAcD,GAAG,CAACE,OAAlB;AACD,OAZI,CAAP;AAaD;;AAED,aAASO,UAAT,GAAsB;AACpB,aAAOrC,IAAI,CAACyB,KAAL,GACJC,OADI,CACI,UADJ,EACgB,GADhB,EACqBR,QAAQ,CAACI,OAD9B,EAEJgB,KAFI,CAEE;AACLL,QAAAA,kBAAkB,EAAEf,QAAQ,CAACC,WADxB;AAELe,QAAAA,aAAa,EAAEhB,QAAQ,CAACG,UAFnB;AAGLe,QAAAA,YAAY,EAAElB,QAAQ,CAACK;AAHlB,OAFF,EAOJI,IAPI,CAOC,UAACzB,IAAD,EAAU;AACd,uDAAwCA,IAAxC;AACD,OATI,WAUE,UAAC0B,GAAD,EAAS;AACdlB,QAAAA,OAAO,CAACmB,KAAR,CAAcD,GAAG,CAACE,OAAlB;AACD,OAZI,CAAP;AAaD,KAvD0B,CAyD3B;;;AACAN,IAAAA,OAAO,GACJG,IADH,CACQ,UAACzB,IAAD,EAAU;AACd,UAAIA,IAAI,KAAKqC,SAAb,EAAwB;AACtB;AACA,eAAOR,UAAU,EAAjB;AACD,OAJa,CAKd;;;AACA,aAAOM,UAAU,EAAjB;AACD,KARH,EASGV,IATH,CASQ,YAAM;AACV;AACA,aAAOH,OAAO,EAAd;AACD,KAZH,EAaGG,IAbH,CAaQ,UAACa,OAAD,EAAa;AACjB,aAAOrC,IAAI,CAAC,IAAD,EAAOqC,OAAP,CAAX;AACD,KAfH;AAgBD,GA1ED;AA2ED,CAnFH,CADF;AAwFA,IAAMC,GAAG,GAAGlD,OAAO,EAAnB,C,CAEA;;AACAkD,GAAG,CAAC7B,GAAJ,CACElB,UAAU,CAACgD,UAAX,CAAsB;AACpBC,EAAAA,QAAQ,EAAE;AADU,CAAtB,CADF,E,CAMA;;AACAF,GAAG,CAAC7B,GAAJ,CAAQlB,UAAU,CAACkD,IAAX,EAAR,E,CAEA;;AACA,IAAMC,SAAS,GAAGlD,IAAI,CAACmD,IAAL,CAAUC,SAAV,EAAqB,UAArB,CAAlB;AACA,IAAMC,UAAU,GAAGrD,IAAI,CAACmD,IAAL,CAAUC,SAAV,EAAqB,gBAArB,CAAnB;AAEAN,GAAG,CAACQ,MAAJ,CAAW,UAAX,EAAuBrD,eAAe,WAAIiD,SAAJ,gBAA0B,WAA1B,CAAtC;AACAJ,GAAG,CAACS,GAAJ,CAAQ,aAAR,EAAuB,UAAvB;AACAT,GAAG,CAACS,GAAJ,CAAQ,OAAR,EAAiB,CAACL,SAAD,EAAYG,UAAZ,CAAjB,E,CAEA;;AACAP,GAAG,CAAC7B,GAAJ,CACEpB,OAAO,CAAC;AACN2D,EAAAA,MAAM,EAAEjE,OAAO,CAACC,GAAR,CAAYiE,cADd;AAENC,EAAAA,IAAI,EAAE,sBAFA;AAGNC,EAAAA,MAAM,EAAE,KAHF;AAINC,EAAAA,iBAAiB,EAAE,KAJb;AAKNC,EAAAA,MAAM,EAAE;AALF,CAAD,CADT;AAUAf,GAAG,CAAC7B,GAAJ,CACEpB,OAAO,CAAC;AACNiE,EAAAA,MAAM,EAAE;AAAEC,IAAAA,MAAM,EAAE;AAAV,GADF;AAENJ,EAAAA,MAAM,EAAE,KAFF;AAGNC,EAAAA,iBAAiB,EAAE,IAHb;AAINI,EAAAA,KAAK,EAAE,IAAIlE,WAAJ,CAAgB;AACrBmE,IAAAA,WAAW,EAAE,QADQ,CACE;;AADF,GAAhB,CAJD;AAONT,EAAAA,MAAM,EAAEjE,OAAO,CAACC,GAAR,CAAYiE;AAPd,CAAD,CADT,E,CAYA;AACA;;AACAX,GAAG,CAAC7B,GAAJ,CAAQf,QAAQ,CAACgE,UAAT,EAAR;AACApB,GAAG,CAAC7B,GAAJ,CAAQf,QAAQ,CAACL,OAAT,EAAR;AACAiD,GAAG,CAAC7B,GAAJ,CAAQrB,OAAO,UAAP,CAAeI,IAAI,CAACmD,IAAL,CAAUC,SAAV,EAAqB,WAArB,CAAf,CAAR,E,CACA;;AACAN,GAAG,CAAC7B,GAAJ,CACErB,OAAO,CAACqD,IAAR,CAAa;AACX;AACA;AACAkB,EAAAA,MAHW,kBAGJC,GAHI,EAGCC,GAHD,EAGMC,GAHN,EAGW;AACpB,QAAIF,GAAG,CAACG,WAAJ,CAAgBC,UAAhB,CAA2B,UAA3B,CAAJ,EAA4C;AAC1CJ,MAAAA,GAAG,CAACK,OAAJ,GAAcH,GAAG,CAACI,QAAJ,EAAd;AACD;AACF;AAPU,CAAb,CADF,E,CAYA;;AACA,IAAMC,MAAM,GAAGjF,OAAO,CAAC,gBAAD,CAAtB;;AAEAoD,GAAG,CAAC7B,GAAJ,CAAQ,GAAR,EAAa0D,MAAb;AACA,IAAMC,IAAI,GAAGrF,OAAO,CAACC,GAAR,CAAYqB,IAAZ,IAAoB,IAAjC;AAEA,IAAMgE,MAAM,GAAG/B,GAAG,CAACgC,MAAJ,CAAWF,IAAX,EAAiB,YAAM;AACpC7D,EAAAA,OAAO,CAACC,GAAR,oCAAwC4D,IAAxC;AACD,CAFc,CAAf","sourcesContent":["// .env workaround for heroku\r\n// stackoverflow.com/questions/59759085/heroku-failed-to-load-env\r\nhttps: if (process.env.NODE_ENV !== \"production\") {\r\n  require(\"dotenv\").config();\r\n}\r\nconst express = require(\"express\");\r\nconst session = require(\"express-session\");\r\nvar MemoryStore = require(\"memorystore\")(session);\r\nconst bodyParser = require(\"body-parser\");\r\nconst path = require(\"path\");\r\nconst mustacheExpress = require(\"mustache-express\");\r\nconst passport = require(\"passport\");\r\nconst SteamStrategy = require(\"../lib/passport-steam/index.js\").Strategy;\r\n\r\nconst User = require(\"../models/user\");\r\n\r\n// TODO: update stripe API to use the newset version (currently using 2019-11-05, newest is 2020-03-02)\r\n// TODO: create automated test cases\r\n\r\n// Passport session setup.\r\n//   To support persistent login sessions, Passport needs to be able to\r\n//   serialize users into and deserialize users out of the session.  Typically,\r\n//   this will be as simple as storing the user ID when serializing, and finding\r\n//   the user by ID when deserializing.  However, since this example does not\r\n//   have a database of user records, the complete Steam profile is serialized\r\n//   and deserialized.\r\npassport.serializeUser(function (user, done) {\r\n  done(null, user);\r\n});\r\n\r\npassport.deserializeUser(function (obj, done) {\r\n  done(null, obj);\r\n});\r\n\r\n// Use the SteamStrategy within Passport.\r\n//   Strategies in passport require a `validate` function, which accept\r\n//   credentials (in this case, an OpenID identifier and profile), and invoke a\r\n//   callback with a user object.\r\n\r\nconst returnURL =\r\n  process.env.BASE_URL + \":\" + process.env.PORT + \"/auth/steam/return\";\r\nconst realm = process.env.BASE_URL + \":\" + process.env.PORT;\r\n\r\nconsole.log(returnURL);\r\nconsole.log(realm);\r\n\r\npassport.use(\r\n  new SteamStrategy(\r\n    {\r\n      returnURL: returnURL,\r\n      realm: realm,\r\n      apiKey: process.env.STEAM_API_KEY,\r\n    },\r\n    function (identifier, profile, done) {\r\n      // asynchronous verification, for effect...\r\n      process.nextTick(function () {\r\n        // console.log(profile._json);\r\n        const userInfo = {\r\n          personaname: profile._json.personaname,\r\n          profileurl: profile._json.profileurl,\r\n          steamid: profile._json.steamid,\r\n          avatarfull: profile._json.avatarfull,\r\n        };\r\n\r\n        // To keep the example simple, the user's Steam profile is returned to\r\n        // represent the logged-in user.\r\n        // TODO: Add support/functionality for other platforms such as Blizzard's Battle.net\r\n        // Associate the Steam account with a user record in your database,\r\n        // and return that user instead in case they have other connections.\r\n        function getUser() {\r\n          return User.query()\r\n            .findOne(\"steam_id\", \"=\", userInfo.steamid)\r\n            .then((user) => {\r\n              return user;\r\n            })\r\n            .catch((err) => {\r\n              console.error(err.message);\r\n            });\r\n        }\r\n\r\n        function insertUser() {\r\n          return User.query()\r\n            .insert({\r\n              steam_persona_name: userInfo.personaname,\r\n              steam_profile: userInfo.profileurl,\r\n              steam_id: userInfo.steamid,\r\n              steam_avatar: userInfo.avatarfull,\r\n            })\r\n            .then((user) => {\r\n              return user;\r\n            })\r\n            .catch((err) => {\r\n              console.error(err.message);\r\n            });\r\n        }\r\n\r\n        function updateUser() {\r\n          return User.query()\r\n            .findOne(\"steam_id\", \"=\", userInfo.steamid)\r\n            .patch({\r\n              steam_persona_name: userInfo.personaname,\r\n              steam_profile: userInfo.profileurl,\r\n              steam_avatar: userInfo.avatarfull,\r\n            })\r\n            .then((user) => {\r\n              return `Successfully updated User ID: ${user}`;\r\n            })\r\n            .catch((err) => {\r\n              console.error(err.message);\r\n            });\r\n        }\r\n\r\n        // check if user exists\r\n        getUser()\r\n          .then((user) => {\r\n            if (user === undefined) {\r\n              // if user does not exist, insert new\r\n              return insertUser();\r\n            }\r\n            // if user does exist, update\r\n            return updateUser();\r\n          })\r\n          .then(() => {\r\n            // get user data at the end\r\n            return getUser();\r\n          })\r\n          .then((results) => {\r\n            return done(null, results);\r\n          });\r\n      });\r\n    }\r\n  )\r\n);\r\n\r\nconst app = express();\r\n\r\n// parse application/x-www-form-urlencoded\r\napp.use(\r\n  bodyParser.urlencoded({\r\n    extended: true,\r\n  })\r\n);\r\n\r\n// parse application/json\r\napp.use(bodyParser.json());\r\n\r\n// set view paths\r\nconst viewsPath = path.join(__dirname, \"../views\");\r\nconst viewsPages = path.join(__dirname, \"../views/pages\");\r\n\r\napp.engine(\"mustache\", mustacheExpress(`${viewsPath}/partials`, \".mustache\"));\r\napp.set(\"view engine\", \"mustache\");\r\napp.set(\"views\", [viewsPath, viewsPages]);\r\n\r\n// start session\r\napp.use(\r\n  session({\r\n    secret: process.env.SESSION_SECRET,\r\n    name: \"potion-break-session\",\r\n    resave: false,\r\n    saveUninitialized: false,\r\n    secure: true,\r\n  })\r\n);\r\n\r\napp.use(\r\n  session({\r\n    cookie: { maxAge: 86400000 },\r\n    resave: false,\r\n    saveUninitialized: true,\r\n    store: new MemoryStore({\r\n      checkPeriod: 86400000, // prune expired entries every 24h\r\n    }),\r\n    secret: process.env.SESSION_SECRET,\r\n  })\r\n);\r\n\r\n// Initialize Passport!  Also use passport.session() middleware, to support\r\n// persistent login sessions (recommended).\r\napp.use(passport.initialize());\r\napp.use(passport.session());\r\napp.use(express.static(path.join(__dirname, \"../public\")));\r\n// stripe webhook local\r\napp.use(\r\n  express.json({\r\n    // We need the raw body to verify webhook signatures.\r\n    // Let's compute it only when hitting the Stripe webhook endpoint.\r\n    verify(req, res, buf) {\r\n      if (req.originalUrl.startsWith(\"/webhook\")) {\r\n        req.rawBody = buf.toString();\r\n      }\r\n    },\r\n  })\r\n);\r\n\r\n// load routes\r\nconst routes = require(\"./routes/index\");\r\n\r\napp.use(\"/\", routes);\r\nconst port = process.env.PORT || 8000;\r\n\r\nconst server = app.listen(port, () => {\r\n  console.log(`Server listening on port ${port}`);\r\n});\r\n"],"file":"index.js"}